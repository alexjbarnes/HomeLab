services:
  roasta:
    image: ghcr.io/alexjbarnes/roasta:latest
    ports:
      - "3002:3002"
    environment:
      - AUTH_MODE=supabase
      - MARKETPLACE_ENABLED=true
      - DATABASE_TYPE=postgres
      - DATABASE_URL=${DATABASE_URL}
      - PORT=3002
      - MIGRATIONS_PATH=/app/migrations
      - GIN_MODE=release
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PRODUCT_MONTHLY=${STRIPE_PRODUCT_MONTHLY}
      - STRIPE_PRODUCT_ANNUAL=${STRIPE_PRODUCT_ANNUAL}
      - IMAGE_BASE_URL=${IMAGE_BASE_URL}
      - S3_ENDPOINT=http://rustfs:9000
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_BUCKET=roasta-images
      - S3_REGION=us-east-1
    depends_on:
      rustfs:
        condition: service_healthy
    restart: unless-stopped

  rustfs:
    image: rustfs/rustfs:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - RUSTFS_VOLUMES=/data/rustfs{0...3}
      - RUSTFS_ADDRESS=0.0.0.0:9000
      - RUSTFS_CONSOLE_ADDRESS=0.0.0.0:9001
      - RUSTFS_ACCESS_KEY=${S3_ACCESS_KEY:-roasta-dev}
      - RUSTFS_SECRET_KEY=${S3_SECRET_KEY:-roasta-dev-secret}
    volumes:
      - rustfs-data-0:/data/rustfs0
      - rustfs-data-1:/data/rustfs1
      - rustfs-data-2:/data/rustfs2
      - rustfs-data-3:/data/rustfs3
    depends_on:
      rustfs-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://127.0.0.1:9000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  rustfs-init:
    image: alpine
    volumes:
      - rustfs-data-0:/data0
      - rustfs-data-1:/data1
      - rustfs-data-2:/data2
      - rustfs-data-3:/data3
    command: sh -c "chown -R 10001:10001 /data0 /data1 /data2 /data3"
    restart: "no"

volumes:
  rustfs-data-0:
  rustfs-data-1:
  rustfs-data-2:
  rustfs-data-3:
