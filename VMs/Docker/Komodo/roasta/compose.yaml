services:
  roasta:
    image: ghcr.io/alexjbarnes/roasta:latest
    ports:
      - "3002:3002"
    environment:
      - AUTH_MODE=supabase
      - MARKETPLACE_ENABLED=true
      - DATABASE_TYPE=postgres
      - DATABASE_URL=${DATABASE_URL}
      - PORT=3002
      - MIGRATIONS_PATH=/app/migrations
      - GIN_MODE=release
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PRODUCT_MONTHLY=${STRIPE_PRODUCT_MONTHLY}
      - STRIPE_PRODUCT_ANNUAL=${STRIPE_PRODUCT_ANNUAL}
      - IMAGE_BASE_URL=${IMAGE_BASE_URL}
      - S3_ENDPOINT=http://rustfs:9000
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_BUCKET=roasta-images
      - S3_REGION=us-east-1
    depends_on:
      rustfs:
        condition: service_healthy
    restart: unless-stopped

  rustfs:
    image: rustfs/rustfs:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - RUSTFS_ROOT_USER=${S3_ACCESS_KEY:-roasta-dev}
      - RUSTFS_ROOT_PASSWORD=${S3_SECRET_KEY:-roasta-dev-secret}
    volumes:
      - rustfs-data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  rustfs-data:
